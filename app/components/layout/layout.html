<!-- 
  LAYOUT ARCHITECTURE:
  - Single wrapper div controls collapsed state via class
  - Sidebar width is the ONLY thing that changes
  - Main area margin-left follows sidebar width
-->
<div class="layout-wrapper" [class.collapsed]="isSidebarCollapsed">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <a class="sidebar-brand" [routerLink]="dashboardUrl">
        <img [src]="IMAGE_PATHS.TP_LOGO" alt="TP Mailer" class="brand-logo">
        <span class="brand-text">TP MAILER</span>
      </a>
    </div>

    <nav class="sidebar-nav">
      <!-- Home -->
      <div class="nav-item" routerLinkActive="active">
        <a class="nav-link" routerLink="/Dashboard" title="Home">
          <i class="fas fa-home"></i>
          <span class="nav-text">Home</span>
        </a>
      </div>

      <!-- App User (ADMIN only) -->
      <div class="nav-item" *ngIf="role === 'ADMIN'" routerLinkActive="active">
        <a class="nav-link" href="javascript:void(0)" data-toggle="collapse" data-target="#collapseAppUser" title="App User">
          <i class="fas fa-user"></i>
          <span class="nav-text">App User</span>
        </a>
        <div id="collapseAppUser" class="collapse" data-parent=".sidebar-nav">
          <div class="collapse-inner">
            <a class="collapse-item d-flex m-0" title="User List" routerLink="/User/UserDetails">
              <span class="material-icons">list</span>
              <span class="nav-text ml-2">User List</span>
            </a>
            <a class="collapse-item d-flex m-0" title="Registration" routerLink="/Admin/AppUser/Registration">
              <span class="material-icons">assignment_add</span>
              <span class="nav-text ml-2">Registration</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Email Service (ADMIN only) -->
      <div class="nav-item" *ngIf="role === 'ADMIN'" routerLinkActive="active">
        <a class="nav-link" href="javascript:void(0)" data-toggle="collapse" data-target="#collapseEmailService" title="Email Service">
          <i class="fas fa-server"></i>
          <span class="nav-text">Email Service</span>
        </a>
        <div id="collapseEmailService" class="collapse" data-parent=".sidebar-nav">
          <div class="collapse-inner">
            <a class="collapse-item d-flex m-0" title="List" routerLink="/Admin/Lookup/EmailServices/List">
              <span class="material-icons">list</span>
              <span class="nav-text ml-2">List</span>
            </a>
            <a class="collapse-item d-flex m-0" title="Add" routerLink="/Admin/Lookup/EmailServices/Add">
              <span class="material-icons">add_comment</span>
              <span class="nav-text ml-2">Add</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Email -->
      <div class="nav-item" routerLinkActive="active">
        <a class="nav-link" href="javascript:void(0)" data-toggle="collapse" data-target="#collapseEmail" title="Email">
          <i class="fas fa-envelope"></i>
          <span class="nav-text">Email</span>
        </a>
        <div id="collapseEmail" class="collapse" data-parent=".sidebar-nav">
          <div class="collapse-inner">
            <a class="collapse-item d-flex m-0" title="List" routerLink="/Email/List">
              <span class="material-icons">list</span>
              <span class="nav-text ml-2">List</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Application -->
      <div class="nav-item" routerLinkActive="active">
        <a class="nav-link" href="javascript:void(0)" data-toggle="collapse" data-target="#collapseApplication" title="Application">
          <i class="fas fa-cube"></i>
          <span class="nav-text">Application</span>
        </a>
        <div id="collapseApplication" class="collapse" data-parent=".sidebar-nav">
          <div class="collapse-inner">
            <a class="collapse-item d-flex m-0" title="List" routerLink="/Application/List">
              <span class="material-icons">list</span>
              <span class="nav-text ml-2">List</span>
            </a>
            <a class="collapse-item d-flex m-0" title="Add" routerLink="/Application/Add">
              <span class="material-icons">add</span>
              <span class="nav-text ml-2">Add</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Profile -->
      <div class="nav-item" routerLinkActive="active">
        <a class="nav-link" href="javascript:void(0)" data-toggle="collapse" data-target="#collapseProfile" title="Profile">
          <i class="fas fa-user-circle"></i>
          <span class="nav-text">Profile</span>
        </a>
        <div id="collapseProfile" class="collapse" data-parent=".sidebar-nav">
          <div class="collapse-inner">
            <a class="collapse-item d-flex m-0" title="Password Update" routerLink="/Account/PasswordUpdate">
              <span class="material-icons">password</span>
              <span class="nav-text ml-2">Password Update</span>
            </a>
          </div>
        </div>
      </div>
    </nav>
  </aside>

  <!-- Main Area -->
  <main class="main-area">
    <header class="topbar">
      <button class="hamburger-btn" (click)="toggleSidebar()" title="Toggle Sidebar" aria-label="Toggle Sidebar">
        <i class="fa fa-bars"></i>
      </button>

      <!-- TP Assist Global Search -->
      <div class="tpassist-search flex-grow-1 mx-3 position-relative" [class.open]="isSearchOpen">
        <button class="btn btn-light border d-flex align-items-center px-3 py-2 w-100 text-start" 
                style="max-width: 400px; border-radius: 8px;" 
                (click)="openSearch()" 
                title="Search TP Mailer">
          <i class="fas fa-search text-muted me-2"></i>
          <span class="text-muted small flex-grow-1">Search TP Mailer...</span>
        </button>

        <!-- Search Modal -->
        <div class="position-absolute bg-white rounded shadow-lg p-0" 
             style="top: 45px; left: 0; width: 100%; max-width: 500px; z-index: 1050; max-height: 70vh; overflow: hidden;"
             *ngIf="isSearchOpen">
          
          <!-- Search Input -->
          <div class="d-flex align-items-center border-bottom px-3 py-2">
            <i class="fas fa-search text-muted me-3"></i>
            <input 
              type="text" 
              class="form-control border-0 shadow-none flex-grow-1 tpassist-input"
              [(ngModel)]="searchQuery"
              (input)="onSearchInput()"
              (keydown)="onSearchKeydown($event)"
              placeholder="Type to search or ask a question..."
              autocomplete="off"
              style="font-size: 1rem;"
              #searchInput
            >
            <span class="me-2" *ngIf="isSearching">
              <i class="fas fa-spinner fa-spin text-primary"></i>
            </span>
            <button class="btn btn-sm btn-light" (click)="closeSearch()">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- Search Results -->
          <div class="overflow-auto" style="max-height: calc(70vh - 60px);">
            
            <!-- Help/Info Full Answer (when a help suggestion is clicked or high confidence) -->
            <div class="p-3" *ngIf="searchResponse?.success && searchResponse?.isHelpResponse">
              <div class="d-flex align-items-start mb-2">
                <span class="badge me-2" style="background-color: #6f42c1; color: white;"><i class="fas fa-lightbulb me-1"></i>{{ searchResponse!.category || 'Answer' }}</span>
                <span class="fw-bold flex-grow-1">{{ searchResponse!.label }}</span>
                <button class="btn btn-sm btn-link text-muted p-0" (click)="searchResponse = null" title="Back to search">
                  <i class="fas fa-arrow-left"></i>
                </button>
              </div>
              <p class="text-muted mb-3" style="line-height: 1.6; white-space: pre-line;">{{ searchResponse!.message }}</p>
              
              <div *ngIf="searchResponse?.suggestions?.length" class="mt-3 pt-2 border-top">
                <small class="text-muted fw-bold text-uppercase">Related</small>
                <div class="list-group list-group-flush mt-2">
                  <a class="list-group-item list-group-item-action d-flex align-items-center py-2 border-0 rounded"
                     href="javascript:void(0)"
                     *ngFor="let suggestion of searchResponse!.suggestions"
                     (click)="onSuggestionClick(suggestion)">
                    <i class="fas fa-arrow-right text-primary me-2"></i>
                    <span>{{ suggestion.label }}</span>
                  </a>
                </div>
              </div>
            </div>

            <!-- Direct Navigation Result (single strong match) -->
            <div class="list-group list-group-flush" *ngIf="searchResponse?.success && searchResponse?.route && !searchResponse?.isHelpResponse">
              <a class="list-group-item list-group-item-action d-flex align-items-center py-3 bg-light border-start border-primary border-4"
                 href="javascript:void(0)"
                 (click)="navigateTo(searchResponse!.route!)">
                <i class="fas fa-arrow-right text-primary me-3"></i>
                <div class="flex-grow-1">
                  <div class="fw-bold">{{ searchResponse!.label }}</div>
                  <small class="text-muted">{{ searchResponse!.message }}</small>
                </div>
                <kbd class="bg-secondary text-white px-2 py-1 rounded small">Enter</kbd>
              </a>
            </div>

            <!-- Message (no matches found) -->
            <div class="alert alert-light m-3 d-flex align-items-center" *ngIf="searchResponse && !searchResponse.success">
              <i class="fas fa-info-circle text-muted me-2"></i>
              <span class="text-muted">{{ searchResponse.message }}</span>
            </div>

            <!-- Suggestions List (smart predictions as user types) -->
            <div *ngIf="searchResponse?.success && searchResponse?.suggestions?.length && !searchResponse?.isHelpResponse && !searchResponse?.route">
              <div class="list-group list-group-flush">
                <a class="list-group-item list-group-item-action d-flex align-items-center py-2"
                   href="javascript:void(0)"
                   *ngFor="let suggestion of searchResponse!.suggestions"
                   (click)="onSuggestionClick(suggestion)">
                  <!-- Icon based on type -->
                  <i class="me-3" 
                     [ngClass]="{
                       'fas fa-question-circle text-info': suggestion.type === 'help',
                       'fas fa-link text-muted': suggestion.type === 'navigate' || !suggestion.type
                     }"></i>
                  <div class="flex-grow-1">
                    <div class="fw-semibold">{{ suggestion.label }}</div>
                  </div>
                  <span class="badge bg-light text-muted small" *ngIf="suggestion.confidence">{{ suggestion.confidence }}%</span>
                  <i class="fas fa-chevron-right text-muted small ms-2" *ngIf="suggestion.type === 'help'"></i>
                </a>
              </div>
            </div>

            <!-- Help text (only when empty) -->
            <div class="text-center py-4 text-muted" *ngIf="!searchQuery && !searchResponse">
              <i class="fas fa-keyboard me-1"></i>
              <span class="small">Type to search features or ask "How do I..."</span>
            </div>

            <!-- Powered by TP Assist -->
            <div class="border-top px-3 py-2 d-flex align-items-center justify-content-center bg-light">
              <small class="text-muted">
                <i class="fas fa-bolt text-warning me-1"></i>
                Powered by <span class="fw-bold" style="color: var(--tp-purple);">TP Assist</span>
              </small>
            </div>
          </div>
        </div>
      </div>

      <div class="user-dropdown" [class.open]="isUserDropdownOpen">
        <div class="dropdown-toggle" (click)="toggleUserDropdown($event)">
          <div class="user-info">
            <span class="user-email">{{ displayName || email }}</span>
            <span class="user-role">{{ role }}</span>
          </div>
          <div class="profile-img-wrapper">
            <img class="profile-img" [src]="headerProfileImage" alt="Profile" *ngIf="headerProfileImage">
            <span class="status-dot"></span>
          </div>
        </div>
        <div class="dropdown-menu" [class.show]="isUserDropdownOpen">
          <div class="dropdown-header">Account</div>
          <a class="dropdown-item" href="javascript:void(0)">
            <i class="fas fa-user"></i>
            Profile
          </a>
          <div class="dropdown-divider"></div>
          <a class="dropdown-item text-danger" href="javascript:void(0)" (click)="logout()">
            <i class="fas fa-sign-out-alt"></i>
            Logout
          </a>
        </div>
      </div>
    </header>

    <div class="content-area">
      <router-outlet></router-outlet>
    </div>

    <footer class="footer">
      Copyright &copy; Tp Email API 2026 | All Rights Reserved
    </footer>
  </main>
</div>
